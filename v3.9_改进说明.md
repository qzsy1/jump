# v3.9 关键精度改进说明

## 与 wangshub 原程序的关键差异

### 差异1: 【最严重】delta_piece_y 计算错误

**原程序（wangshub）**:
```python
# 第183-193行：使用对称中心计算
center_x = w / 2 + (24 / 1080) * w
center_y = h / 2 + (17 / 1920) * h

if piece_x > center_x:
    board_y = round((25.5 / 43.5) * (board_x - center_x) + center_y)
    delta_piece_y = piece_y - round((25.5 / 43.5) * (piece_x - center_x) + center_y)
else:
    board_y = round(-(25.5 / 43.5) * (board_x - center_x) + center_y)
    delta_piece_y = piece_y - round(-(25.5 / 43.5) * (piece_x - center_x) + center_y)
```

**当前实现（v3.8 已修复）**:
```python
# 第114-116行：添加了对称中心计算
center_x, center_y = self._find_symmetry_center(w, h)
delta_piece_y = self._calculate_delta_piece_y(piece_x, piece_y, center_x, center_y)
```

**影响**:
- 原先的实现（v3.8 之前）：delta_piece_y = piece_y - h / 2
  - 这是屏幕中心，不是真实的相对偏移
  - 高度修正完全不起作用！
- 修复后：计算棋子相对于对称中心的真实偏移
  - 高度修正可以正常工作

---

### 差异2: 平台检测抗干扰机制

**原程序（wangshub）**:
```python
# 第169-178行：检查Y轴下面5个像素，和背景色相同，那么是干扰
ver_pixel = im_pixel[j, i + 5]
# 检查Y轴下面像素和当前像素的色差
color_diff = (abs(pixel[0] - ver_pixel[0]) +
               abs(pixel[1] - ver_pixel[1]) +
               abs(pixel[2] - ver_pixel[2]))
if color_diff > 10:
    board_x_sum += j  # 色差大，可能是干扰，跳过这个像素
```

**当前实现**:
- 没有这个抗干扰机制
- 容易将噪声误判为平台

**影响**:
- 可能选中错误的亮色区域作为目标平台
- 导致跳到错误位置

---

### 差异3: 扫描起始点检测

**原程序（wangshub）**:
```python
# 第116-126行：以50px步长，尝试探测扫描起始Y
# 检测到不是纯色的线，则记录 scan_start_y 的值
for i in range(int(h / 3), int(h * 2 / 3), 50):
    last_pixel = im_pixel[0, i]
    for j in range(1, w):
        pixel = im_pixel[j, i]
        if pixel != last_pixel:
            scan_start_y = i - 50
            break
```

**当前实现**:
```python
# 直接从固定的 Y 范围开始扫描，没有智能起始点检测
search_y_start = max(int(h * 0.2), int(piece_y - 150))
```

**影响**:
- 可能错过一些边界情况
- 扫描范围可能不准确

---

### 差异4: 备用方案简化

**原程序**:
```python
# 备用方案：从上顶点往下搜索
# 检测特殊花纹点（r245 g245 b245）
```

**当前实现**:
- 非常简单的平均亮色位置
- 缺少复杂的错误处理

---

## v3.9 改进内容

### 已完成的修复：
1. ✓ 对称中心计算函数 `_find_symmetry_center()`
2. ✓ 真实 delta_piece_y 计算函数 `_calculate_delta_piece_y()`
3. ✓ 平台检测抗干扰机制（已添加到代码，需要验证）

### 仍需完善的修复：
1. 扫描起始点智能检测
2. 改进备用平台检测方案
3. 统一颜色检测参数

---

## 使用说明

v3.9 主要修复了 delta_piece_y 计算错误的问题。

使用时请注意观察：
1. 检查 debug 窗口的 delta_piece_y 值是否合理（通常在 -100 到 +100 范围）
2. 如果 delta_piece_y 始终是 0，说明对称中心计算可能有问题
3. 观察跳跃效果，根据需要调整 press_coefficient

---

## 建议测试步骤

1. 运行程序，观察 debug 输出的 delta_piece_y 值
2. 先在固定位置手动测试几次短距离跳跃
3. 根据效果调整 press_coefficient（1.2 - 2.0 范围）
4. 如果效果不稳定，可以考虑进一步添加扫描起始点检测等改进
